name: SonarQube
on:
  push:
    branches:
      - main
      - master
      - develop
      - release/**
      - hotfix/**
      - feature/**
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: 21
          distribution: 'zulu' # Alternative distribution options are available.
      - name: Cache SonarQube packages
        uses: actions/cache@v5
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache Maven packages
        uses: actions/cache@v5
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Set up Artifactory npm authentication
        run: |
          # Verify secrets are set
          if [ -z "${{ secrets.ARTIFACTORY_USERNAME }}" ] || [ -z "${{ secrets.ARTIFACTORY_PASSWORD }}" ]; then
            echo "‚ùå ERROR: ARTIFACTORY_USERNAME or ARTIFACTORY_PASSWORD secret is not set"
            exit 1
          fi
          ARTIFACTORY_NPM_AUTH=$(echo -n "${{ secrets.ARTIFACTORY_USERNAME }}:${{ secrets.ARTIFACTORY_PASSWORD }}" | base64 | tr -d '\n')
          echo "ARTIFACTORY_NPM_AUTH=$ARTIFACTORY_NPM_AUTH" >> $GITHUB_ENV
          # Create .npmrc with actual auth token (npm doesn't expand env vars in .npmrc)
          # Ensure no trailing newlines or whitespace in the auth token
          echo "registry=https://repox.jfrog.io/artifactory/api/npm/npm/" > frontend/.npmrc
          echo "//repox.jfrog.io/artifactory/api/npm/npm/:_auth=$ARTIFACTORY_NPM_AUTH" >> frontend/.npmrc
          echo "always-auth=true" >> frontend/.npmrc
          # Also create in home directory as fallback (npm checks multiple locations)
          mkdir -p ~/.npm
          cp frontend/.npmrc ~/.npmrc
          # Verify .npmrc was created correctly (without exposing the token)
          echo "‚úÖ .npmrc created at frontend/.npmrc and ~/.npmrc"
          echo "Registry: $(grep '^registry=' frontend/.npmrc)"
          echo "Auth configured: $(grep -c '_auth=' frontend/.npmrc) line(s)"
          echo "File exists: $(test -f frontend/.npmrc && echo 'yes' || echo 'no')"
          echo "File size: $(wc -c < frontend/.npmrc) bytes"
      - name: Configure Maven settings.xml for Artifactory
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>artifactory</id>
                <username>${{ secrets.ARTIFACTORY_USERNAME }}</username>
                <password>${{ secrets.ARTIFACTORY_PASSWORD }}</password>
              </server>
            </servers>
          </settings>
          EOF
      - name: Verify npm configuration before build
        working-directory: frontend
        run: |
          echo "üìÅ Current directory: $(pwd)"
          echo "üìÑ .npmrc location: $(pwd)/.npmrc"
          echo "üìÑ .npmrc exists: $(test -f .npmrc && echo 'yes' || echo 'no')"
          if [ -f .npmrc ]; then
            echo "üìÑ .npmrc contents (masked):"
            sed 's/:_auth=.*/:_auth=***MASKED***/' .npmrc
            echo ""
            echo "üîç npm config registry:"
            # Use the npm that will be installed by Maven (if available) or check config
            if command -v npm &> /dev/null; then
              npm config get registry || echo "npm not yet installed"
            else
              echo "npm will be installed by Maven"
            fi
          else
            echo "‚ùå ERROR: .npmrc file not found!"
            exit 1
          fi
      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar