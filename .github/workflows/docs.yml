name: Build and Deploy Documentation

on:
  push:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:  # Allows manual triggering

# Sets permissions for GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          registry-url: 'https://registry.npmjs.org'

      - name: Set up Artifactory npm authentication
        run: |
          # Verify secrets are set
          if [ -z "${{ secrets.ARTIFACTORY_USERNAME }}" ] || [ -z "${{ secrets.ARTIFACTORY_PASSWORD }}" ]; then
            echo "‚ùå ERROR: ARTIFACTORY_USERNAME or ARTIFACTORY_PASSWORD secret is not set"
            exit 1
          fi
          ARTIFACTORY_NPM_AUTH=$(echo -n "${{ secrets.ARTIFACTORY_USERNAME }}:${{ secrets.ARTIFACTORY_PASSWORD }}" | base64 | tr -d '\n')
          echo "ARTIFACTORY_NPM_AUTH=$ARTIFACTORY_NPM_AUTH" >> $GITHUB_ENV
          # Create .npmrc with actual auth token (npm doesn't expand env vars in .npmrc)
          # Ensure no trailing newlines or whitespace in the auth token
          echo "registry=https://repox.jfrog.io/artifactory/api/npm/npm/" > frontend/.npmrc
          echo "//repox.jfrog.io/artifactory/api/npm/npm/:_auth=$ARTIFACTORY_NPM_AUTH" >> frontend/.npmrc
          echo "always-auth=true" >> frontend/.npmrc
          # Also create in home directory as fallback (npm checks multiple locations)
          mkdir -p ~/.npm
          cp frontend/.npmrc ~/.npmrc
          # Verify .npmrc was created correctly (without exposing the token)
          echo "‚úÖ .npmrc created at frontend/.npmrc and ~/.npmrc"
          echo "Registry: $(grep '^registry=' frontend/.npmrc)"
          echo "Auth configured: $(grep -c '_auth=' frontend/.npmrc) line(s)"
          echo "File exists: $(test -f frontend/.npmrc && echo 'yes' || echo 'no')"
          echo "File size: $(wc -c < frontend/.npmrc) bytes"
      - name: Configure Maven settings.xml for Artifactory
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>artifactory</id>
                <username>${{ secrets.ARTIFACTORY_USERNAME }}</username>
                <password>${{ secrets.ARTIFACTORY_PASSWORD }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Build project and generate documentation
        run: |
          # Build the project (this generates TypeDoc for frontend)
          mvn clean install -DskipTests
          echo "‚úÖ Build completed"
          
          # Explicitly generate JavaDoc to ensure it's created
          echo "üìö Generating JavaDoc explicitly..."
          mvn javadoc:javadoc -pl backend
          
          # Verify JavaDoc was generated
          # JavaDoc may be in apidocs or apidocs/apidocs depending on Maven version
          JAVADOC_DIR=""
          if [ -f "backend/target/site/apidocs/index.html" ]; then
            JAVADOC_DIR="backend/target/site/apidocs"
            echo "‚úÖ Backend JavaDoc found at backend/target/site/apidocs"
          elif [ -f "backend/target/site/apidocs/apidocs/index.html" ]; then
            JAVADOC_DIR="backend/target/site/apidocs/apidocs"
            echo "‚úÖ Backend JavaDoc found at backend/target/site/apidocs/apidocs (nested structure)"
          elif [ -d "backend/target/site/apidocs" ]; then
            echo "‚ö†Ô∏è  JavaDoc directory exists but index.html not found in expected locations"
            echo "   Searching for index.html:"
            find backend/target/site/apidocs -name "index.html" -type f
            # Try to find the actual JavaDoc location
            JAVADOC_DIR=$(find backend/target/site/apidocs -name "index.html" -type f | head -1 | xargs dirname)
            if [ -n "$JAVADOC_DIR" ]; then
              echo "‚úÖ Found JavaDoc at: $JAVADOC_DIR"
            else
              echo "‚ùå ERROR: Could not locate JavaDoc index.html"
              exit 1
            fi
          else
            echo "‚ùå ERROR: Backend JavaDoc directory not found"
            echo "   Checking backend/target structure:"
            find backend/target -type d -name "*doc*" 2>/dev/null | head -10
            exit 1
          fi
          
          if [ -n "$JAVADOC_DIR" ]; then
            echo "   Total files in JavaDoc: $(find "$JAVADOC_DIR" -type f | wc -l)"
          fi
          
          # Verify TypeDoc was generated
          if [ -d "frontend/target/site/typedoc" ]; then
            echo "‚úÖ Frontend TypeDoc found at frontend/target/site/typedoc"
          else
            echo "‚ö†Ô∏è  Frontend TypeDoc NOT found"
          fi

      - name: Prepare documentation site
        run: |
          # Create a docs-site directory for GitHub Pages
          mkdir -p docs-site
          
          # Get the build timestamp in a readable format
          BUILD_TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          # Create index page that links to both documentation sets
          cat > docs-site/index.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>SonarShowcase Documentation</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 1200px;
                      margin: 0 auto;
                      padding: 40px 20px;
                      background: #f5f5f5;
                  }
                  .container {
                      background: white;
                      border-radius: 8px;
                      padding: 40px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  h1 {
                      color: #333;
                      border-bottom: 3px solid #4CAF50;
                      padding-bottom: 10px;
                  }
                  .docs-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 20px;
                      margin-top: 30px;
                  }
                  .doc-card {
                      border: 2px solid #e0e0e0;
                      border-radius: 8px;
                      padding: 20px;
                      transition: all 0.3s;
                      background: #fafafa;
                  }
                  .doc-card:hover {
                      border-color: #4CAF50;
                      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                      transform: translateY(-2px);
                  }
                  .doc-card h2 {
                      margin-top: 0;
                      color: #4CAF50;
                  }
                  .doc-card a {
                      display: inline-block;
                      margin-top: 15px;
                      padding: 10px 20px;
                      background: #4CAF50;
                      color: white;
                      text-decoration: none;
                      border-radius: 4px;
                      font-weight: bold;
                  }
                  .doc-card a:hover {
                      background: #45a049;
                  }
                  .description {
                      color: #666;
                      line-height: 1.6;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üìö SonarShowcase Documentation</h1>
                  <p>Welcome to the API documentation for the SonarShowcase project. Select a documentation set below:</p>
                  
                  <div class="docs-grid">
                      <div class="doc-card">
                          <h2>üî∑ Backend API (JavaDoc)</h2>
                          <p class="description">
                              Complete Java API documentation for the Spring Boot backend, including all classes, methods, and parameters.
                          </p>
                          <a href="./backend/">View Backend Docs ‚Üí</a>
                      </div>
                      
                      <div class="doc-card">
                          <h2>‚öõÔ∏è Frontend API (TypeDoc)</h2>
                          <p class="description">
                              TypeScript/React component documentation including services, hooks, utilities, and type definitions.
                          </p>
                          <a href="./frontend/">View Frontend Docs ‚Üí</a>
                      </div>
                  </div>
                  
                  <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e0e0e0; color: #999; font-size: 0.9em;">
                      <p>üìù Documentation is automatically generated from source code during the build process.</p>
                      <p>üîÑ Last updated: ${BUILD_TIMESTAMP}</p>
                  </div>
              </div>
          </body>
          </html>
          EOF
          
          # Copy backend JavaDoc
          # Find the actual JavaDoc directory (handles nested apidocs/apidocs structure)
          JAVADOC_SOURCE=""
          if [ -f "backend/target/site/apidocs/index.html" ]; then
            JAVADOC_SOURCE="backend/target/site/apidocs"
          elif [ -f "backend/target/site/apidocs/apidocs/index.html" ]; then
            JAVADOC_SOURCE="backend/target/site/apidocs/apidocs"
          else
            # Fallback: search for it
            JAVADOC_SOURCE=$(find backend/target/site/apidocs -name "index.html" -type f | head -1 | xargs dirname)
            if [ -z "$JAVADOC_SOURCE" ]; then
              echo "‚ùå ERROR: Could not locate JavaDoc source directory"
              exit 1
            fi
          fi
          
          echo "üìÅ Copying JavaDoc from: $JAVADOC_SOURCE"
          # Remove existing backend directory to avoid nested structures
          rm -rf docs-site/backend
          mkdir -p docs-site/backend
          # Copy all files and directories from JavaDoc source to backend
          cp -r "$JAVADOC_SOURCE"/* docs-site/backend/ 2>/dev/null || true
          # Also copy hidden files if any
          cp -r "$JAVADOC_SOURCE"/.[!.]* docs-site/backend/ 2>/dev/null || true
          echo "‚úÖ Backend JavaDoc copied"
          # Verify index.html exists
          if [ -f "docs-site/backend/index.html" ]; then
            echo "‚úÖ Backend index.html found at docs-site/backend/index.html"
            echo "   Backend docs file count: $(find docs-site/backend -type f | wc -l) files"
          else
            echo "‚ùå Backend index.html NOT found after copy"
            echo "   Files in docs-site/backend/:"
            ls -la docs-site/backend/ | head -20
            echo "   Source directory ($JAVADOC_SOURCE) contents:"
            ls -la "$JAVADOC_SOURCE" | head -20
            exit 1
          fi
          
          # Copy frontend TypeDoc
          if [ -d "frontend/target/site/typedoc" ]; then
            mkdir -p docs-site/frontend
            cp -r frontend/target/site/typedoc/* docs-site/frontend/
            echo "‚úÖ Frontend TypeDoc copied"
          else
            echo "‚ö†Ô∏è  Frontend TypeDoc not found"
          fi
          
          # List what we have
          echo "üìÅ Documentation site structure:"
          find docs-site -type f -name "*.html" | head -10

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs-site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

